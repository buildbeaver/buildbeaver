.PHONY: build test generate generate-wire generate-grpc run-server run-runner

REPO_ROOT			:= $(shell git rev-parse --show-top-level)
PROJECT_ROOT		:= $(abspath $(dir $(MAKEFILE_LIST)))
PKG					= github.com/buildbeaver/buildbeaver
ifeq ($(OS),Windows_NT)
       VERSION_INFO            = $(shell git describe --long --tags --always)
       GIT_SHA_SHORT           = $(shell git rev-parse --short=12 HEAD)
else
       VERSION_INFO            = $(shell ../build/scripts/version-info.sh)
       GIT_SHA_SHORT           = $(shell ../build/scripts/version-info.sh sha-short)
endif
VERSION_VAR			=-X $(PKG)/common/version.VERSION=$(VERSION_INFO) -X $(PKG)/common/version.GITCOMMIT=$(GIT_SHA_SHORT)
GO_LDFLAGS			=-ldflags "$(VERSION_VAR)"

generate: generate-wire

generate-grpc:
	@echo "--- generate grpc ---"
	protoc \
		--go_out=plugins,paths=source_relative:"$(PROJECT_ROOT)/server/api/grpc/" \
		--proto_path=$(PROJECT_ROOT)/server/api/grpc \
		$(PROJECT_ROOT)/server/api/grpc/*.proto;

generate-wire:
	@echo "--- generate wire ---"
	cd server/app && wire
	cd server/app/server_test && wire
	cd runner/app && wire
	cd runner/app/runner_test && wire
	cd bb/app && wire

build:
	@echo "--- build ---"
	cd server/cmd/bb-server && go install ${GO_LDFLAGS}
	cd runner/cmd/bb-runner && go install ${GO_LDFLAGS}
	cd bb/cmd/bb && go install ${GO_LDFLAGS}
	cd server/cmd/bb-tools && go install ${GO_LDFLAGS}

build-runner:
	@echo "--- build runner only ---"
	cd runner/cmd/bb-runner && go install ${GO_LDFLAGS}

build-bb:
	@echo "--- build bb command line only ---"
	cd bb/cmd/bb && go install ${GO_LDFLAGS}

test:
	@echo "--- test ---"
	go test -mod=vendor ./...

run-server:
	@echo "--- run server (BuildBeaver app)---"
	bb-server \
	--api_server_address "127.0.0.1:3001" \
	--api_server_session_authentication_key abcdefghijklmnopqrstuvwxyz123456 \
	--api_server_session_encryption_key abcdefghijklmnopqrstuvwxyz123456 \
	--api_server_github_auth_redirect_url "http://localhost:3001/api/v1/authentication/github/callback" \
	--dev_api_server_use_same_site_none_mode=true \
	--runner_api_server_address "127.0.0.1:3002" \
	--runner_api_auto_created_certificate_host "localhost,127.0.0.1,[::1]" \
	--github_app_id 866992 \
	--github_client_id "Iv1.89b31353a4b970b5" \
	--github_client_secret "put-client-secret-here" \
	--github_app_commit_status_target_url "http://localhost:3000" \
	--key_manager_local_master_key abcdefghijklmnopqrstuvwxyz123456 \
	--dev_start_internal_runners=true \
	--github_app_deploy_key_name=buildbeaver-dev-autogenerated \
	--jwt_auto_create_key_pair=true

run-server-no-runners:
	@echo "--- run server (no internal runners) ---"
	bb-server \
	--api_server_address "127.0.0.1:3001" \
	--api_server_session_authentication_key abcdefghijklmnopqrstuvwxyz123456 \
	--api_server_session_encryption_key abcdefghijklmnopqrstuvwxyz123456 \
	--api_server_github_auth_redirect_url "http://localhost:3001/api/v1/authentication/github/callback" \
	--dev_api_server_use_same_site_none_mode=true \
	--runner_api_server_address "127.0.0.1:3002" \
	--runner_api_auto_created_certificate_host "localhost,127.0.0.1,[::1]" \
	--github_app_id 866992 \
	--github_client_id "Iv1.89b31353a4b970b5" \
	--github_client_secret "put-client-secret-here" \
	--github_app_commit_status_target_url "http://localhost:3000" \
	--key_manager_local_master_key abcdefghijklmnopqrstuvwxyz123456 \
	--dev_start_internal_runners=false \
	--github_app_deploy_key_name=buildbeaver-dev-autogenerated \
	--jwt_auto_create_key_pair=true

run-server-postgres:
	@echo "--- run server (postgres) ---"
	bb-server \
	--api_server_address "127.0.0.1:3001" \
	--api_server_session_authentication_key abcdefghijklmnopqrstuvwxyz123456 \
	--api_server_session_encryption_key abcdefghijklmnopqrstuvwxyz123456 \
	--api_server_github_auth_redirect_url "http://localhost:3001/api/v1/authentication/github/callback" \
	--dev_api_server_use_same_site_none_mode=true \
	--runner_api_server_address "127.0.0.1:3002" \
	--runner_api_auto_created_certificate_host "localhost,127.0.0.1,[::1]" \
	--github_app_id 866992 \
	--github_client_id "Iv1.89b31353a4b970b5" \
	--github_client_secret "put-client-secret-here" \
	--key_manager_local_master_key abcdefghijklmnopqrstuvwxyz123456 \
	--dev_start_internal_runners=true \
	--github_app_deploy_key_name=buildbeaver-dev-autogenerated \
	--database_driver postgres \
	--database_connection_string "postgresql://buildbeaver:password@localhost:5432?sslmode=disable" \
	--jwt_auto_create_key_pair=true

# NOTE: use "--log_levels APIClient=trace" to get extra logging of HTTP requests
# NOTE: To have runner talk to staging environment, use "--runner_api_endpoints='https://runner.staging.changeme.com'"
# NOTE: To have runner talk to local development server, use "--runner_api_endpoints='https://localhost:3002'"
run-runner:
	@echo "--- run runner ---"
	bb-runner \
	--dev_insecure_skip_verify=true \
	--runner_api_endpoints='https://localhost:3002' \
	--dynamic_api_endpoint='http://localhost:3001'

# TODO: Replace the API endpoints with the domain your instance is running on
run-runner-staging:
	@echo "--- run runner (connected to staging) ---"
	bb-runner \
	--dev_insecure_skip_verify=true \
	--runner_api_endpoints='https://runner.staging.changeme.com' \
	--dynamic_api_endpoint='https://app.staging.changeme.com'
